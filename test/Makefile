## -*- Mode: Makefile; -*-                                              
##
## The 'bestguess' project
##

PROGRAMS=optiontest bestguess
SRCDIR=../src
OBJECTS=$(SRCDIR)/optable.o

default: $(PROGRAMS)

help:
	@echo "Useful makefile targets (test directory)"
	@echo "  default Build test programs"
	@echo "  test    Build and run test programs"
	@echo "  clean   Deletes old compilation files"
	@echo "  deps    Rebuilds dependency info in Makefile.depends"
	@echo "  tags    Rebuilds tag files e.g. for Emacs"
	@echo "  config  Print important configuration settings"

include $(SRCDIR)/Makefile.defines
include Makefile.depends

# Log levels: 0=confess, 1=warn, 2=info, 3=trace
LOGLEVEL ?= 1
COPT ?= -O2 

CWARNS = -Wall -Wextra \
	 -Wcast-align \
	 -Wcast-qual \
	 -Wdisabled-optimization \
	 -Wpointer-arith \
	 -Wshadow \
	 -Wsign-compare \
	 -Wundef \
	 -Wwrite-strings \
	 -Wbad-function-cast \
	 -Wmissing-prototypes \
	 -Wnested-externs \
	 -Wstrict-prototypes \
         -Wunreachable-code \
         -Wno-missing-declarations \
	 -Wno-variadic-macros

# ------------------------------------------------------------------

CFLAGS= -std=c99 -fPIC \
	$(SYSCFLAGS) $(ASAN_FLAGS) \
	$(CWARNS) -DLOGLEVEL=$(LOGLEVEL) $(COPT) -I $(SRCDIR)

# -----------------------------------------------------------------------------

bestguess:
	$(MAKE) -C $(SRCDIR) bestguess

optiontest: TAGS optiontest.o $(OBJECTS)
	$(CC) $(CFLAGS) -o $@ $@.c $(OBJECTS) 

test: $(PROGRAMS)
	@./optiontest
	./test-basic.sh && \
	./test-exec-and-report.sh && \
	./test-report.sh && \
	./test-rawdata.sh && \
	./test-report-csv.sh


# ------------------------------------------------------------------

deps:
	printf '# Automatically generated by "make deps"\n' >Makefile.depends && \
	$(CC) -I $(SRCDIR) -MM *.c >>Makefile.depends

clean:
	-rm -f $(PROGRAMS)
	-rm -f *.o *.gcda *.gcov *.gcno

tags TAGS: *.[ch]
	@if ! type "etags" > /dev/null 2>&1; then \
	echo "INFO: etags not found, skipping TAGS file update"; \
	else \
	  echo "INFO: running etags to update TAGS file"; \
	  etags -o TAGS *.[ch]; \
	fi

.PHONY: default test run deps clean tags help
